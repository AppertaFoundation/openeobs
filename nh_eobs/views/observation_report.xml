<openerp>
    <data>

        <template id="observation_report_footer">
            <div class="footer">
                <div class="col-xs-9">
                        <p><strong>REF:</strong> <t t-esc="user_name"/> - <t t-esc="time_generated"/> - <t t-esc="hospital_name"/> - <t t-esc="patient['other_identifier']"/></p>
                </div>
                <div class="col-xs-3 pull-right">
                    <p>Page: <span class="page"/>/<span class="topage"/></p>
                </div>
            </div>
        </template>

        <template id="observation_report_header">
            <div class="header">
                <div class="row">
                    <div class="col-xs-9">
                        <h2><t t-esc="patient['full_name']"/></h2>
                    </div>
                    <div class="col-xs-3 pull-right">
                        <img t-if="company_logo" t-att-src="'data:image/png;base64,%s' % company_logo" style="max-height: 45px;"/>
                    </div>
                </div>
                <div class="row zero_min_height">
                    <div class="col-xs-12">
                        <div style="border-bottom: 1px solid black;"></div>
                    </div>
                </div>
            </div>
        </template>


        <template id="observation_report_layout">
            <t t-call="nh_eobs.observation_report_header"/>
            <t t-raw="0"/>
            <t t-call="nh_eobs.observation_report_footer"/>
        </template>

        <template id="observation_report_header_override" inherit_id="report.layout" primary="True">
            <xpath expr="//head" position="inside">
                <style>

                    svg .title{
                        font-weight: bold;
                    }

                    svg .axis path,
                    svg .axis line {
                        fill: none;
                        stroke: #262626;
                        shape-rendering: crispEdges;
                    }
                    svg .axis text {
                        font-family: sans-serif;
                    }
                    svg .y.axis text{
                        font-size: 8px;
                    }
                    svg .background .green {
                        fill: #ccffcc;
                    }
                    svg .background .amber {
                        fill: #ffe9c8;
                    }
                    svg .background .red {
                        fill: #ffcccc;
                    }
                    svg .background .normal {
                        fill: rgba(0, 0, 0, 0.2);
                        stroke: rgba(0, 0, 0, 0.2);
                    }
                    svg .background line {
                        fill: none;
                        stroke: rgba(0, 0, 0, 0.15);
                        shape-rendering: crispEdges;
                    }
                    svg .brush {
                        fill: rgba(0, 0, 0, 0.3);
                    }
                    svg .data path {
                        fill: none;
                        stroke: rgba(40, 40, 40, 0.6);
                        shape-rendering: optimizeSpeed;
                    }
                </style>
            </xpath>
        </template>

        <template id="html_container">
            <t t-set="body_classname" t-value="'container'"/>
            <t t-call="nh_eobs.observation_report_header_override">
                <t t-call="nh_eobs.observation_report_layout">
                    <t t-raw="0"/>
                </t>
            </t>
        </template>


        <template id="observation_report">
            <t t-call="nh_eobs.html_container">
                <div class="page">
                    <div class="col-xs-12 row">
                        <h1>Patient Observation Chart</h1>
                    </div>
                    <div class="col-xs-12 row">
                        <table>
                            <tr>
                                <td>
                                    <h2>Patient</h2>
                                    <table>
                                        <tr>
                                            <td>Hospital No:</td><td><t t-esc="patient['other_identifier']"/></td>
                                        </tr>
                                        <tr>
                                            <td>DOB:</td><td><t t-esc="patient['dob']"/></td>
                                        </tr>
                                        <tr>
                                            <td>Gender:</td><td><t t-esc="patient['gender']"/></td>
                                        </tr>
                                        <t t-if="patient['patient_identifier']">
                                            <tr>
                                                <td>NHS No:</td><td><t t-esc="patient['patient_identifier']"/></td>
                                            </tr>
                                        </t>
                                        <t t-if="patient['height']">
                                            <tr>
                                                <td>Height:</td><td><t t-esc="patient['height']"/>m</td>
                                            </tr>
                                        </t>
                                        <t t-if="patient['weight']">
                                            <tr>
                                                <td>Weight:</td><td><t t-esc="patient['weight']"/>kg</td>
                                            </tr>
                                        </t>
                                        <tr>
                                            <td></td><td></td>
                                        </tr>
                                    </table>
                                </td>
                                <td>
                                    <h2>Hospital Visit</h2>
                                    <table>
                                        <tr>
                                            <td>Location:</td>
                                            <td>
                                                <t t-if="'bed' in patient">
                                                    <t t-esc="patient['bed']"/>,
                                                </t>
                                                <t t-if="'ward' in patient">
                                                    <t t-esc="patient['ward']"/>
                                                </t>
                                            </td>
                                        </tr>
                                        <t t-if="len(transfer_history) > 1">
                                            <tr>
                                                <td>Transfer History:</td><td>See additional pages</td>
                                            </tr>
                                        </t>
                                        <tr>
                                            <td>Report Period:</td><td><t t-esc="report_start"/> - <t t-esc="report_end"/></td>
                                        </tr>
                                        <t t-if="spell['consultants']">
                                            <tr>
                                                <td>Consulting Doctor(s):</td><td><ul><li t-foreach="spell['consultants']" t-as="doctor"><t t-esc="doctor['name']"/></li></ul></td>
                                            </tr>
                                        </t>
                                        <tr>
                                            <td>Admission:</td><td><t t-esc="spell['code']"/> - <t t-esc="spell_start"/></td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-xs-12 row">
                        <div id="chart" style="width: 800px; height: 810px;"></div>
                        <script type="text/javascript" src="/nh_graphs/static/lib/js/d3.js"></script>
                        <script type="text/javascript" src="/nh_graphs/static/src/js/nh_graphlib.js"></script>
                        <script type="text/javascript">var obs_data = <t t-raw="ews_data"/>;</script>
                        <script type="text/javascript" t-att-src="draw_graph_js"></script>
                    </div>
                    <!--<p style="page-break-before: always;"></p>-->
                    <t t-if="len(weights) > 0">
                        <div class="row">
                            <h3>Weight Values</h3>
                            <table class="striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="weights" t-as="weight">
                                        <tr>
                                            <td><t t-esc="weight['values']['date_terminated']"/></td>
                                            <td><t t-esc="weight['values']['weight']"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                            <p></p>
                        </div>
                    </t>
                    <t t-if="len(pbps) > 0 ">
                        <div class="row">
                            <h3>Postural Blood Pressure Values</h3>
                            <table class="striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>User</th>
                                        <th>Dehydrated</th>
                                        <th>Values</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="pbps" t-as="pbp_ob">
                                        <tr>
                                            <td><t t-esc="pbp_ob['date_terminated']"/></td>
                                            <td><t t-esc="pbp_ob['terminate_uid'][1]"/></td>
                                            <td><t t-esc="pbp_ob['values']['result']"/></td>
                                            <td>
                                                <table class="pbp-data striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Position</th>
                                                            <th>Systolic</th>
                                                            <th>Diastolic</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>Sitting</td>
                                                            <td><t t-esc="pbp_ob['values']['systolic_sitting']"/></td>
                                                            <td><t t-esc="pbp_ob['values']['diastolic_sitting']"/></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Standing</td>
                                                            <td><t t-esc="pbp_ob['values']['systolic_standing']"/></td>
                                                            <td><t t-esc="pbp_ob['values']['diastolic_standing']"/></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                            <p></p>
                        </div>
                    </t>

                    <t t-if="len(targeto2) > 0">
                        <div class="row">
                            <h3>O2 Target Values</h3>
                            <table class="striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Target</th>
                                        <th>User</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="targeto2" t-as="o2">
                                        <tr class="main-entry">
                                            <td><t t-esc="o2['values']['date_terminated']"/></td>
                                            <td><t t-esc="o2['values']['level_id'][1]"/></td>
                                            <td><t t-esc="o2['write_uid'][1]"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                            <p></p>
                        </div>
                    </t>

                    <t t-if="len(transfer_history) > 0">
                        <div class="row">
                            <h3>Transfer History</h3>
                            <table class="striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Bed</th>
                                        <th>Ward</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="transfer_history" t-as="transfer">
                                        <tr class="main-entry">
                                            <td><t t-esc="transfer['date_terminated']"/></td>
                                            <td><t t-esc="transfer['bed']"/></td>
                                            <td><t t-esc="transfer['ward']"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                            <p></p>
                        </div>
                    </t>

                    <t t-if="len(ews) > 0">
                        <div class="row">
                            <h3>Actions Triggered</h3>
                            <table class="striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>EWS Score</th>
                                        <th>Clinical Risk</th>
                                        <th>Action Taken</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="ews" t-as="observation">
                                        <tr class="main-entry">
                                            <td><t t-esc="observation['date_terminated']"/></td>
                                            <td><t t-esc="observation['values']['score']"/></td>
                                            <td><t t-esc="observation['values']['clinical_risk']"/></td>
                                            <td>
                                                <table class="pre-compact-data">
                                                    <t t-foreach="observation['triggered_actions']" t-as="task">
                                                        <tr>
                                                            <td>
                                                                <table class="compact-data">
                                                                    <tr>
                                                                        <td colspan="2" class="header">
                                                                            <h4><t t-esc="task['summary']"/></h4>
                                                                        </td>
                                                                    </tr>
                                                                    <t t-if="task['notes']">
                                                                        <tr>
                                                                            <td colspan="2"><t t-esc="task['notes']"/></td>
                                                                        </tr>
                                                                    </t>
                                                                    <tr>
                                                                        <td><t t-if="task['user_id']"><strong>By:</strong> <t t-esc="task['user_id'][1]"/></t></td>
                                                                        <td><t t-if="task['date_terminated']"><strong>Date:</strong> <t t-esc="task['date_terminated']"/></t><br/>
                                                                            <t t-if="task['date_terminated']==False">
                                                                                    Task still in progress
                                                                            </t>
                                                                        </td>
                                                                    </tr>
                                                                </table>
                                                            </td>
                                                        </tr>
                                                    </t>
                                                </table>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </t>
                </div>
            </t>
        </template>
    </data>
</openerp>